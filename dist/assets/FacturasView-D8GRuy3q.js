import{_ as U,Y as S,Z as y,$ as o,aa as I,ax as k,aH as z,a2 as A,a1 as G,b as i,a6 as x,a7 as _,a0 as Y,a8 as q,h as D,a5 as P,ad as N,V as E,a4 as p,a9 as b,ab as B,av as X,am as v,ag as K,az as W,aA as Z,aB as M,aC as H,m as J,ak as L,aF as Q}from"./index-DV75wFlE.js";import{c as C}from"./_commonjsHelpers-Cpj98o6Y.js";var R={exports:{}};(function(e,a){(function(m,c){c()})(C,function(){function m(r,s){return typeof s>"u"?s={autoBom:!1}:typeof s!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),s={autoBom:!s}),s.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(r.type)?new Blob(["\uFEFF",r],{type:r.type}):r}function c(r,s,g){var l=new XMLHttpRequest;l.open("GET",r),l.responseType="blob",l.onload=function(){h(l.response,s,g)},l.onerror=function(){console.error("could not download file")},l.send()}function n(r){var s=new XMLHttpRequest;s.open("HEAD",r,!1);try{s.send()}catch{}return 200<=s.status&&299>=s.status}function d(r){try{r.dispatchEvent(new MouseEvent("click"))}catch{var s=document.createEvent("MouseEvents");s.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),r.dispatchEvent(s)}}var t=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof C=="object"&&C.global===C?C:void 0,u=t.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),h=t.saveAs||(typeof window!="object"||window!==t?function(){}:"download"in HTMLAnchorElement.prototype&&!u?function(r,s,g){var l=t.URL||t.webkitURL,f=document.createElement("a");s=s||r.name||"download",f.download=s,f.rel="noopener",typeof r=="string"?(f.href=r,f.origin===location.origin?d(f):n(f.href)?c(r,s,g):d(f,f.target="_blank")):(f.href=l.createObjectURL(r),setTimeout(function(){l.revokeObjectURL(f.href)},4e4),setTimeout(function(){d(f)},0))}:"msSaveOrOpenBlob"in navigator?function(r,s,g){if(s=s||r.name||"download",typeof r!="string")navigator.msSaveOrOpenBlob(m(r,g),s);else if(n(r))c(r,s,g);else{var l=document.createElement("a");l.href=r,l.target="_blank",setTimeout(function(){d(l)})}}:function(r,s,g,l){if(l=l||open("","_blank"),l&&(l.document.title=l.document.body.innerText="downloading..."),typeof r=="string")return c(r,s,g);var f=r.type==="application/octet-stream",O=/constructor/i.test(t.HTMLElement)||t.safari,T=/CriOS\/[\d]+/.test(navigator.userAgent);if((T||f&&O||u)&&typeof FileReader<"u"){var F=new FileReader;F.onloadend=function(){var w=F.result;w=T?w:w.replace(/^data:[^;]*;/,"data:attachment/file;"),l?l.location.href=w:location=w,l=null},F.readAsDataURL(r)}else{var V=t.URL||t.webkitURL,j=V.createObjectURL(r);l?l.location=j:location.href=j,l=null,setTimeout(function(){V.revokeObjectURL(j)},4e4)}});t.saveAs=h.saveAs=h,e.exports=h})})(R);var $=R.exports;const ee={name:"FacturasView",data(){return{fechaDesde:"",fechaHasta:"",facturas:[],loading:!1,mensaje:"",tipoMensaje:"info",url:"https://api-tpv.confinsoft.com/public",cabeceras:[{title:"N° Factura",value:"factura.numero_factura",sortable:!0},{title:"Fecha",value:"factura.fecha",sortable:!0},{title:"Cliente",value:"cliente.nombre",sortable:!0},{title:"CAE",value:"factura.cae",sortable:!0},{title:"Vto CAE",value:"factura.vto_cae",sortable:!0},{title:"Monto",value:"monto",sortable:!0},{title:"Tipo",value:"factura.tipo_factura",sortable:!0},{title:"Nota Crédito",value:"factura.nota_de_credito",sortable:!1},{title:"Acciones",value:"acciones",sortable:!1}]}},setup(){return{usuario:G()}},methods:{async consultarFacturas(){if(!this.fechaDesde||!this.fechaHasta){this.mensaje="Por favor, seleccione ambas fechas.",this.tipoMensaje="warning";return}if(new Date(this.fechaDesde)>new Date(this.fechaHasta)){this.mensaje="La fecha desde no puede ser mayor que la fecha hasta.",this.tipoMensaje="warning";return}this.loading=!0,this.mensaje="",this.facturas=[];try{let e=this.fechaDesde+" 00:00:00",a=this.fechaHasta+" 23:59:59";const m=await A.get(`${this.url}/${this.usuario.tpv}/ventas/facturas`,{params:{fecha_desde:e,fecha_hasta:a},headers:{Authorization:this.usuario.token},timeout:15e3});m.status===200&&(this.facturas=m.data||[],this.facturas.length===0?(this.mensaje="No se encontraron facturas en el rango de fechas seleccionado.",this.tipoMensaje="info"):(this.mensaje=`Se encontraron ${this.facturas.length} facturas.`,this.tipoMensaje="success"))}catch(e){console.error("Error al consultar facturas:",e),e.response&&e.response.status===401?(this.mensaje="No tienes permisos para consultar facturas.",this.tipoMensaje="error"):e.response&&e.response.data&&e.response.data.message?(this.mensaje=e.response.data.message,this.tipoMensaje="error"):(this.mensaje="Error al consultar las facturas. Intente nuevamente.",this.tipoMensaje="error")}finally{this.loading=!1}},formatearFecha(e){if(!e)return"";const a={year:"numeric",month:"2-digit",day:"2-digit"};return new Date(e).toLocaleDateString("es-AR",a)},formatearFechaYHora(e){if(!e)return"";const a={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};return new Date(e).toLocaleDateString("es-AR",a)},formatearMonto(e){return e?Number(e).toLocaleString("es-AR",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00"},getTipoFacturaTexto(e){return{1:"Factura A",2:"Nota de Débito A",3:"Nota de Crédito A",4:"Recibo A",5:"Nota de Venta al contado A",6:"Factura B",7:"Nota de Débito B",8:"Nota de Crédito B",9:"Recibo B",10:"Nota de Venta al contado B",11:"Factura C",12:"Nota de Débito C",13:"Nota de Crédito C"}[e]||`Tipo ${e}`},getTipoFacturaColor(e){return[1,6,11].includes(e)?"primary":[3,8,13].includes(e)?"warning":[2,7,12].includes(e)?"error":"grey"},verFactura(e){var a;this.$swal({title:"¿Desea ver la factura?",text:`Se abrirá la factura N° ${String((a=e.factura)==null?void 0:a.numero_factura).padStart(8,"0")} en una nueva ventana`,icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, ver factura!",cancelButtonText:"Cancelar"}).then(m=>{if(m.isConfirmed){let c=e.id,n=this.usuario.token,d=this.url+"/"+this.usuario.tpv+"/ventas/imprimirCbte/"+c+"/"+n;window.open(d,"_blank"),console.log("ver factura:",c)}})},generarNotaCredito(e){var a;console.log("Generar nota de crédito para factura:",e),this.$swal({title:"¿Generar nota de crédito?",text:`Se generará una nota de crédito para la factura N° ${String((a=e.factura)==null?void 0:a.numero_factura).padStart(8,"0")} y anulación de la venta. Esta acción no se puede deshacer.`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#f57c00",cancelButtonColor:"#d33",confirmButtonText:"Sí, generar!",cancelButtonText:"Cancelar"}).then(m=>{m.isConfirmed&&(this.loading=!0,A.post(this.url+"/"+this.usuario.tpv+"/notasCredito/generar",{venta_id:e.id},{headers:{Authorization:this.usuario.token}}).then(c=>{var n;A.post(this.url+"/"+this.usuario.tpv+"/ventas/rollback/"+e.id,{},{headers:{Authorization:this.usuario.token}}),this.$swal("Nota de crédito generada",`Se ha generado exitosamente la nota de crédito para la factura N° ${String((n=e.factura)==null?void 0:n.numero_factura).padStart(8,"0")}`,"success"),this.consultarFacturas()}).catch(c=>{console.error("Error al generar nota de crédito:",c);let n="Error al generar la nota de crédito. Intente nuevamente.";c.response&&c.response.data&&c.response.data.message&&(n=c.response.data.message),this.$swal("Error",n,"error")}).finally(()=>{this.loading=!1}))})},exportarAExcel(){if(this.facturas.length===0){this.$swal("Advertencia","No hay datos para exportar.","warning");return}const e=this.facturas.map(t=>{var u,h,r,s,g,l,f;return{"N° Factura":String((u=t.factura)==null?void 0:u.numero_factura).padStart(8,"0"),Fecha:this.formatearFechaYHora((h=t.factura)==null?void 0:h.created_at),Cliente:((r=t.cliente)==null?void 0:r.nombre)||"",CAE:((s=t.factura)==null?void 0:s.cae)||"","Vto CAE":this.formatearFecha((g=t.factura)==null?void 0:g.vto_cae),Monto:this.formatearMonto(t.monto),Tipo:this.getTipoFacturaTexto((l=t.factura)==null?void 0:l.tipo_factura),"Nota de Crédito":(f=t.factura)!=null&&f.nota_de_credito?`N°${t.factura.nota_de_credito.numero_nota}`:""}}),a=k.json_to_sheet(e),m=k.book_new();k.book_append_sheet(m,a,"Facturas");const c=z(m,{bookType:"xlsx",type:"array"}),n=new Blob([c],{type:"application/octet-stream"}),d=new Date().toISOString().split("T")[0];$.saveAs(n,`Facturas_${d}.xlsx`)},establecerFechasDefault(){const e=new Date,a=new Date(e.getFullYear(),e.getMonth(),1);this.fechaDesde=a.toISOString().split("T")[0],this.fechaHasta=e.toISOString().split("T")[0]}},mounted(){this.establecerFechasDefault()}},ae={key:0},te={key:1};function oe(e,a,m,c,n,d){return y(),S(I,null,{default:o(()=>[i(x,null,{default:o(()=>[i(_,null,{default:o(()=>[i(Y,null,{default:o(()=>[i(q,null,{default:o(()=>[...a[2]||(a[2]=[D("h2",null,"Facturas",-1)])]),_:1}),i(P,null,{default:o(()=>[i(x,{class:"mb-4"},{default:o(()=>[i(_,{md:"4",sm:"6",cols:"12"},{default:o(()=>[i(N,{modelValue:n.fechaDesde,"onUpdate:modelValue":a[0]||(a[0]=t=>n.fechaDesde=t),label:"Fecha Desde",type:"date",variant:"outlined",readonly:n.loading},null,8,["modelValue","readonly"])]),_:1}),i(_,{md:"4",sm:"6",cols:"12"},{default:o(()=>[i(N,{modelValue:n.fechaHasta,"onUpdate:modelValue":a[1]||(a[1]=t=>n.fechaHasta=t),label:"Fecha Hasta",type:"date",variant:"outlined",readonly:n.loading},null,8,["modelValue","readonly"])]),_:1}),i(_,{md:"4",sm:"12",cols:"12",class:"d-flex align-center"},{default:o(()=>[i(E,{color:"primary",onClick:d.consultarFacturas,loading:n.loading,disabled:!n.fechaDesde||!n.fechaHasta||n.loading},{default:o(()=>[i(b,{left:""},{default:o(()=>[...a[3]||(a[3]=[p("mdi-magnify",-1)])]),_:1}),a[4]||(a[4]=p(" Consultar ",-1))]),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1}),i(x,{class:"mb-3"},{default:o(()=>[i(_,null,{default:o(()=>[n.mensaje?(y(),S(X,{key:0,type:n.tipoMensaje,class:"mt-4"},{default:o(()=>[p(v(n.mensaje),1)]),_:1},8,["type"])):B("",!0)]),_:1})]),_:1}),i(K,{headers:n.cabeceras,items:n.facturas,loading:n.loading,"loading-text":"Cargando facturas...","no-data-text":"No se encontraron facturas en el rango de fechas seleccionado","items-per-page":"10",class:"elevation-1"},{"item.factura.numero_factura":o(({item:t})=>{var u;return[p(v(String((u=t.factura)==null?void 0:u.numero_factura).padStart(8,"0")),1)]}),"item.factura.fecha":o(({item:t})=>{var u;return[p(v(d.formatearFechaYHora((u=t.factura)==null?void 0:u.created_at)),1)]}),"item.factura.vto_cae":o(({item:t})=>{var u;return[p(v(d.formatearFecha((u=t.factura)==null?void 0:u.vto_cae)),1)]}),"item.monto":o(({item:t})=>[p(" $"+v(d.formatearMonto(t.monto)),1)]),"item.factura.tipo_factura":o(({item:t})=>{var u;return[i(Q,{color:d.getTipoFacturaColor((u=t.factura)==null?void 0:u.tipo_factura),size:"small"},{default:o(()=>{var h;return[p(v(d.getTipoFacturaTexto((h=t.factura)==null?void 0:h.tipo_factura)),1)]}),_:2},1032,["color"])]}),"item.factura.nota_de_credito":o(({item:t})=>{var u;return[(u=t.factura)!=null&&u.nota_de_credito?(y(),L("div",ae,[i(b,{color:"warning"},{default:o(()=>[...a[5]||(a[5]=[p(" mdi-file-document-minus ",-1)])]),_:1}),D("span",null," N°"+v(t.factura.nota_de_credito.numero_nota),1)])):(y(),L("span",te,"-"))]}),"item.acciones":o(({item:t})=>[i(W,{location:"bottom end"},{activator:o(({props:u})=>{var h;return[i(E,J(u,{icon:"",size:"small",color:"primary",title:`Acciones factura N° ${String((h=t.factura)==null?void 0:h.numero_factura).padStart(8,"0")}`}),{default:o(()=>[i(b,null,{default:o(()=>[...a[6]||(a[6]=[p("mdi-dots-vertical",-1)])]),_:1})]),_:1},16,["title"])]}),default:o(()=>[i(Z,{density:"compact"},{default:o(()=>{var u;return[i(M,{onClick:h=>d.verFactura(t)},{prepend:o(()=>[i(b,null,{default:o(()=>[...a[7]||(a[7]=[p("mdi-eye",-1)])]),_:1})]),default:o(()=>[i(H,null,{default:o(()=>[...a[8]||(a[8]=[p("Ver factura",-1)])]),_:1})]),_:1},8,["onClick"]),(u=t.factura)!=null&&u.nota_de_credito?B("",!0):(y(),S(M,{key:0,onClick:h=>d.generarNotaCredito(t)},{prepend:o(()=>[i(b,null,{default:o(()=>[...a[9]||(a[9]=[p("mdi-file-document-minus",-1)])]),_:1})]),default:o(()=>[i(H,null,{default:o(()=>[...a[10]||(a[10]=[p("Generar nota de credito",-1)])]),_:1})]),_:1},8,["onClick"]))]}),_:2},1024)]),_:2},1024)]),_:1},8,["headers","items","loading"]),i(x,{class:"mt-4",justify:"end"},{default:o(()=>[i(_,null,{default:o(()=>[i(E,{color:"success",disabled:n.facturas.length===0||n.loading,onClick:d.exportarAExcel},{default:o(()=>[i(b,{left:""},{default:o(()=>[...a[11]||(a[11]=[p("mdi-file-excel",-1)])]),_:1}),a[12]||(a[12]=p(" Exportar a Excel ",-1))]),_:1},8,["disabled","onClick"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}const se=U(ee,[["render",oe]]);export{se as default};
