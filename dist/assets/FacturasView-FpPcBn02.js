import{aa as L,ab as T,ac as b,ad as n,an as O,ag as D,af as U,h as l,ak as x,al as _,ae as z,am as I,l as N,aj as q,aq as V,z as F,ai as g,v as y,ao as B,aI as G,az as v,at as Y,ax as M,aQ as P}from"./index-Dz5lV3rp.js";import{u as k,a as X}from"./xlsx-5_gWIQju.js";var C=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},H={exports:{}};(function(a,t){(function(p,u){u()})(C,function(){function p(o,r){return typeof r>"u"?r={autoBom:!1}:typeof r!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),r={autoBom:!r}),r.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(o.type)?new Blob(["\uFEFF",o],{type:o.type}):o}function u(o,r,h){var i=new XMLHttpRequest;i.open("GET",o),i.responseType="blob",i.onload=function(){m(i.response,r,h)},i.onerror=function(){console.error("could not download file")},i.send()}function s(o){var r=new XMLHttpRequest;r.open("HEAD",o,!1);try{r.send()}catch{}return 200<=r.status&&299>=r.status}function d(o){try{o.dispatchEvent(new MouseEvent("click"))}catch{var r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),o.dispatchEvent(r)}}var e=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof C=="object"&&C.global===C?C:void 0,c=e.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),m=e.saveAs||(typeof window!="object"||window!==e?function(){}:"download"in HTMLAnchorElement.prototype&&!c?function(o,r,h){var i=e.URL||e.webkitURL,f=document.createElement("a");r=r||o.name||"download",f.download=r,f.rel="noopener",typeof o=="string"?(f.href=o,f.origin===location.origin?d(f):s(f.href)?u(o,r,h):d(f,f.target="_blank")):(f.href=i.createObjectURL(o),setTimeout(function(){i.revokeObjectURL(f.href)},4e4),setTimeout(function(){d(f)},0))}:"msSaveOrOpenBlob"in navigator?function(o,r,h){if(r=r||o.name||"download",typeof o!="string")navigator.msSaveOrOpenBlob(p(o,h),r);else if(s(o))u(o,r,h);else{var i=document.createElement("a");i.href=o,i.target="_blank",setTimeout(function(){d(i)})}}:function(o,r,h,i){if(i=i||open("","_blank"),i&&(i.document.title=i.document.body.innerText="downloading..."),typeof o=="string")return u(o,r,h);var f=o.type==="application/octet-stream",R=/constructor/i.test(e.HTMLElement)||e.safari,E=/CriOS\/[\d]+/.test(navigator.userAgent);if((E||f&&R||c)&&typeof FileReader<"u"){var j=new FileReader;j.onloadend=function(){var w=j.result;w=E?w:w.replace(/^data:[^;]*;/,"data:attachment/file;"),i?i.location.href=w:location=w,i=null},j.readAsDataURL(o)}else{var A=e.URL||e.webkitURL,S=A.createObjectURL(o);i?i.location=S:location.href=S,i=null,setTimeout(function(){A.revokeObjectURL(S)},4e4)}});e.saveAs=m.saveAs=m,a.exports=m})})(H);var K=H.exports;const Q={name:"FacturasView",data(){return{fechaDesde:"",fechaHasta:"",facturas:[],loading:!1,mensaje:"",tipoMensaje:"info",url:"https://api-tpv.confinsoft.com/public",cabeceras:[{title:"N° Factura",value:"factura.numero_factura",sortable:!0},{title:"Fecha",value:"factura.fecha",sortable:!0},{title:"Cliente",value:"cliente.nombre",sortable:!0},{title:"CAE",value:"factura.cae",sortable:!0},{title:"Vto CAE",value:"factura.vto_cae",sortable:!0},{title:"Monto",value:"monto",sortable:!0},{title:"Tipo",value:"factura.tipo_factura",sortable:!0},{title:"Nota Crédito",value:"factura.nota_de_credito",sortable:!1},{title:"Acciones",value:"acciones",sortable:!1}]}},setup(){return{usuario:U()}},methods:{async consultarFacturas(){if(!this.fechaDesde||!this.fechaHasta){this.mensaje="Por favor, seleccione ambas fechas.",this.tipoMensaje="warning";return}if(new Date(this.fechaDesde)>new Date(this.fechaHasta)){this.mensaje="La fecha desde no puede ser mayor que la fecha hasta.",this.tipoMensaje="warning";return}this.loading=!0,this.mensaje="",this.facturas=[];try{let a=this.fechaDesde+" 00:00:00",t=this.fechaHasta+" 23:59:59";const p=await D.get(`${this.url}/${this.usuario.tpv}/ventas/facturas`,{params:{fecha_desde:a,fecha_hasta:t},headers:{Authorization:this.usuario.token},timeout:15e3});p.status===200&&(this.facturas=p.data||[],this.facturas.length===0?(this.mensaje="No se encontraron facturas en el rango de fechas seleccionado.",this.tipoMensaje="info"):(this.mensaje=`Se encontraron ${this.facturas.length} facturas.`,this.tipoMensaje="success"))}catch(a){console.error("Error al consultar facturas:",a),a.response&&a.response.status===401?(this.mensaje="No tienes permisos para consultar facturas.",this.tipoMensaje="error"):a.response&&a.response.data&&a.response.data.message?(this.mensaje=a.response.data.message,this.tipoMensaje="error"):(this.mensaje="Error al consultar las facturas. Intente nuevamente.",this.tipoMensaje="error")}finally{this.loading=!1}},formatearFecha(a){if(!a)return"";const t={year:"numeric",month:"2-digit",day:"2-digit"};return new Date(a).toLocaleDateString("es-AR",t)},formatearFechaYHora(a){if(!a)return"";const t={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};return new Date(a).toLocaleDateString("es-AR",t)},formatearMonto(a){return a?Number(a).toLocaleString("es-AR",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00"},getTipoFacturaTexto(a){return{1:"Factura A",2:"Nota de Débito A",3:"Nota de Crédito A",4:"Recibo A",5:"Nota de Venta al contado A",6:"Factura B",7:"Nota de Débito B",8:"Nota de Crédito B",9:"Recibo B",10:"Nota de Venta al contado B",11:"Factura C",12:"Nota de Débito C",13:"Nota de Crédito C"}[a]||`Tipo ${a}`},getTipoFacturaColor(a){return[1,6,11].includes(a)?"primary":[3,8,13].includes(a)?"warning":[2,7,12].includes(a)?"error":"grey"},verFactura(a){var t;this.$swal({title:"¿Desea ver la factura?",text:`Se abrirá la factura N° ${String((t=a.factura)==null?void 0:t.numero_factura).padStart(8,"0")} en una nueva ventana`,icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, ver factura!",cancelButtonText:"Cancelar"}).then(p=>{if(p.isConfirmed){let u=a.id,s=this.usuario.token,d=this.url+"/"+this.usuario.tpv+"/ventas/imprimirCbte/"+u+"/"+s;window.open(d,"_blank"),console.log("ver factura:",u)}})},generarNotaCredito(a){var t;this.$swal({title:"¿Generar nota de crédito?",text:`Se generará una nota de crédito para la factura N° ${String((t=a.factura)==null?void 0:t.numero_factura).padStart(8,"0")}. Esta acción no se puede deshacer.`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#f57c00",cancelButtonColor:"#d33",confirmButtonText:"Sí, generar!",cancelButtonText:"Cancelar"}).then(p=>{p.isConfirmed&&(this.loading=!0,D.post(this.url+"/"+this.usuario.tpv+"/notasCredito/generar",{venta_id:a.id},{headers:{Authorization:this.usuario.token}}).then(u=>{var s;this.$swal("Nota de crédito generada",`Se ha generado exitosamente la nota de crédito para la factura N° ${String((s=a.factura)==null?void 0:s.numero_factura).padStart(8,"0")}`,"success"),this.consultarFacturas()}).catch(u=>{console.error("Error al generar nota de crédito:",u);let s="Error al generar la nota de crédito. Intente nuevamente.";u.response&&u.response.data&&u.response.data.message&&(s=u.response.data.message),this.$swal("Error",s,"error")}).finally(()=>{this.loading=!1}))})},exportarAExcel(){if(this.facturas.length===0){this.$swal("Advertencia","No hay datos para exportar.","warning");return}const a=this.facturas.map(e=>{var c,m,o,r,h,i,f;return{"N° Factura":String((c=e.factura)==null?void 0:c.numero_factura).padStart(8,"0"),Fecha:this.formatearFechaYHora((m=e.factura)==null?void 0:m.created_at),Cliente:((o=e.cliente)==null?void 0:o.nombre)||"",CAE:((r=e.factura)==null?void 0:r.cae)||"","Vto CAE":this.formatearFecha((h=e.factura)==null?void 0:h.vto_cae),Monto:this.formatearMonto(e.monto),Tipo:this.getTipoFacturaTexto((i=e.factura)==null?void 0:i.tipo_factura),"Nota de Crédito":(f=e.factura)!=null&&f.nota_de_credito?`N°${e.factura.nota_de_credito.numero_nota}`:""}}),t=k.json_to_sheet(a),p=k.book_new();k.book_append_sheet(p,t,"Facturas");const u=X(p,{bookType:"xlsx",type:"array"}),s=new Blob([u],{type:"application/octet-stream"}),d=new Date().toISOString().split("T")[0];K.saveAs(s,`Facturas_${d}.xlsx`)},establecerFechasDefault(){const a=new Date,t=new Date(a.getFullYear(),a.getMonth(),1);this.fechaDesde=t.toISOString().split("T")[0],this.fechaHasta=a.toISOString().split("T")[0]}},mounted(){this.establecerFechasDefault()}},W={key:0},J={key:1};function Z(a,t,p,u,s,d){return b(),T(O,null,{default:n(()=>[l(x,null,{default:n(()=>[l(_,null,{default:n(()=>[l(z,null,{default:n(()=>[l(I,null,{default:n(()=>[...t[2]||(t[2]=[N("h2",null,"Facturas",-1)])]),_:1}),l(q,null,{default:n(()=>[l(x,{class:"mb-4"},{default:n(()=>[l(_,{md:"4",sm:"6",cols:"12"},{default:n(()=>[l(V,{modelValue:s.fechaDesde,"onUpdate:modelValue":t[0]||(t[0]=e=>s.fechaDesde=e),label:"Fecha Desde",type:"date",variant:"outlined",readonly:s.loading},null,8,["modelValue","readonly"])]),_:1}),l(_,{md:"4",sm:"6",cols:"12"},{default:n(()=>[l(V,{modelValue:s.fechaHasta,"onUpdate:modelValue":t[1]||(t[1]=e=>s.fechaHasta=e),label:"Fecha Hasta",type:"date",variant:"outlined",readonly:s.loading},null,8,["modelValue","readonly"])]),_:1}),l(_,{md:"4",sm:"12",cols:"12",class:"d-flex align-center"},{default:n(()=>[l(F,{color:"primary",onClick:d.consultarFacturas,loading:s.loading,disabled:!s.fechaDesde||!s.fechaHasta||s.loading},{default:n(()=>[l(y,{left:""},{default:n(()=>[...t[3]||(t[3]=[g("mdi-magnify",-1)])]),_:1}),t[4]||(t[4]=g(" Consultar ",-1))]),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1}),l(x,{class:"mb-3"},{default:n(()=>[l(_,null,{default:n(()=>[s.mensaje?(b(),T(G,{key:0,type:s.tipoMensaje,class:"mt-4"},{default:n(()=>[g(v(s.mensaje),1)]),_:1},8,["type"])):B("",!0)]),_:1})]),_:1}),l(Y,{headers:s.cabeceras,items:s.facturas,loading:s.loading,"loading-text":"Cargando facturas...","no-data-text":"No se encontraron facturas en el rango de fechas seleccionado","items-per-page":"10",class:"elevation-1"},{"item.factura.numero_factura":n(({item:e})=>{var c;return[g(v(String((c=e.factura)==null?void 0:c.numero_factura).padStart(8,"0")),1)]}),"item.factura.fecha":n(({item:e})=>{var c;return[g(v(d.formatearFechaYHora((c=e.factura)==null?void 0:c.created_at)),1)]}),"item.factura.vto_cae":n(({item:e})=>{var c;return[g(v(d.formatearFecha((c=e.factura)==null?void 0:c.vto_cae)),1)]}),"item.monto":n(({item:e})=>[g(" $"+v(d.formatearMonto(e.monto)),1)]),"item.factura.tipo_factura":n(({item:e})=>{var c;return[l(P,{color:d.getTipoFacturaColor((c=e.factura)==null?void 0:c.tipo_factura),size:"small"},{default:n(()=>{var m;return[g(v(d.getTipoFacturaTexto((m=e.factura)==null?void 0:m.tipo_factura)),1)]}),_:2},1032,["color"])]}),"item.factura.nota_de_credito":n(({item:e})=>{var c;return[(c=e.factura)!=null&&c.nota_de_credito?(b(),M("div",W,[l(y,{color:"warning"},{default:n(()=>[...t[5]||(t[5]=[g(" mdi-file-document-minus ",-1)])]),_:1}),N("span",null," N°"+v(e.factura.nota_de_credito.numero_nota),1)])):(b(),M("span",J,"-"))]}),"item.acciones":n(({item:e})=>{var c,m,o;return[l(F,{icon:"",size:"small",color:"primary",onClick:r=>d.verFactura(e),title:`Ver factura N° ${String((c=e.factura)==null?void 0:c.numero_factura).padStart(8,"0")}`,class:"mr-1"},{default:n(()=>[l(y,null,{default:n(()=>[...t[6]||(t[6]=[g("mdi-eye",-1)])]),_:1})]),_:1},8,["onClick","title"]),(m=e.factura)!=null&&m.nota_de_credito?B("",!0):(b(),T(F,{key:0,icon:"",size:"small",color:"warning",onClick:r=>d.generarNotaCredito(e),title:`Generar nota de crédito para factura N° ${String((o=e.factura)==null?void 0:o.numero_factura).padStart(8,"0")}`},{default:n(()=>[l(y,null,{default:n(()=>[...t[7]||(t[7]=[g("mdi-file-document-minus",-1)])]),_:1})]),_:1},8,["onClick","title"]))]}),_:1},8,["headers","items","loading"]),l(x,{class:"mt-4",justify:"end"},{default:n(()=>[l(_,null,{default:n(()=>[l(F,{color:"success",disabled:s.facturas.length===0||s.loading,onClick:d.exportarAExcel},{default:n(()=>[l(y,{left:""},{default:n(()=>[...t[8]||(t[8]=[g("mdi-file-excel",-1)])]),_:1}),t[9]||(t[9]=g(" Exportar a Excel ",-1))]),_:1},8,["disabled","onClick"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}const ae=L(Q,[["render",Z]]);export{ae as default};
