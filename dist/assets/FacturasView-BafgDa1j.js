import{_ as w,Y as g,Z as f,$ as t,a8 as y,a2 as v,a1 as j,b as o,a6 as b,a7 as m,a0 as x,ad as B,h as D,a5 as T,ao as F,aa as V,V as _,a4 as i,af as p,ae as k,aj as N,al as c,aD as M,av as A}from"./index-DbTXfS4c.js";const E={name:"FacturasView",data(){return{fechaDesde:"",fechaHasta:"",facturas:[],loading:!1,mensaje:"",tipoMensaje:"info",url:"https://api-tpv.confinsoft.com/public",cabeceras:[{title:"N° Factura",value:"factura.numero_factura",sortable:!0},{title:"Fecha",value:"factura.fecha",sortable:!0},{title:"Cliente",value:"cliente.nombre",sortable:!0},{title:"CAE",value:"factura.cae",sortable:!0},{title:"Vto CAE",value:"factura.vto_cae",sortable:!0},{title:"Monto",value:"monto",sortable:!0},{title:"Tipo",value:"factura.tipo_factura",sortable:!0},{title:"Nota Crédito",value:"factura.nota_de_credito",sortable:!1},{title:"Acciones",value:"acciones",sortable:!1}]}},setup(){return{usuario:j()}},methods:{async consultarFacturas(){if(!this.fechaDesde||!this.fechaHasta){this.mensaje="Por favor, seleccione ambas fechas.",this.tipoMensaje="warning";return}if(new Date(this.fechaDesde)>new Date(this.fechaHasta)){this.mensaje="La fecha desde no puede ser mayor que la fecha hasta.",this.tipoMensaje="warning";return}this.loading=!0,this.mensaje="",this.facturas=[];try{const a=new FormData;a.append("fecha_desde",this.fechaDesde),a.append("fecha_hasta",this.fechaHasta);const e=await v.get(`${this.url}/${this.usuario.tpv}/ventas/facturas`,{params:{fecha_desde:this.fechaDesde,fecha_hasta:this.fechaHasta},headers:{Authorization:this.usuario.token},timeout:15e3});e.status===200&&(this.facturas=e.data||[],this.facturas.length===0?(this.mensaje="No se encontraron facturas en el rango de fechas seleccionado.",this.tipoMensaje="info"):(this.mensaje=`Se encontraron ${this.facturas.length} facturas.`,this.tipoMensaje="success"))}catch(a){console.error("Error al consultar facturas:",a),a.response&&a.response.status===401?(this.mensaje="No tienes permisos para consultar facturas.",this.tipoMensaje="error"):a.response&&a.response.data&&a.response.data.message?(this.mensaje=a.response.data.message,this.tipoMensaje="error"):(this.mensaje="Error al consultar las facturas. Intente nuevamente.",this.tipoMensaje="error")}finally{this.loading=!1}},formatearFecha(a){return a?new Date(a).toLocaleDateString("es-AR"):""},formatearMonto(a){return a?Number(a).toLocaleString("es-AR",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00"},getTipoFacturaTexto(a){return{1:"Factura A",2:"Nota de Débito A",3:"Nota de Crédito A",4:"Recibo A",5:"Nota de Venta al contado A",6:"Factura B",7:"Nota de Débito B",8:"Nota de Crédito B",9:"Recibo B",10:"Nota de Venta al contado B",11:"Factura C",12:"Nota de Débito C",13:"Nota de Crédito C"}[a]||`Tipo ${a}`},getTipoFacturaColor(a){return[1,6,11].includes(a)?"primary":[3,8,13].includes(a)?"warning":[2,7,12].includes(a)?"error":"grey"},verFactura(a){var e;this.$swal({title:"¿Desea ver la factura?",text:`Se abrirá la factura N° ${String((e=a.factura)==null?void 0:e.numero_factura).padStart(8,"0")} en una nueva ventana`,icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, ver factura!",cancelButtonText:"Cancelar"}).then(h=>{if(h.isConfirmed){let l=a.id,r=this.usuario.token,u=this.url+"/"+this.usuario.tpv+"/ventas/imprimirCbte/"+l+"/"+r;window.open(u,"_blank"),console.log("ver factura:",l)}})},generarNotaCredito(a){var e;this.$swal({title:"¿Generar nota de crédito?",text:`Se generará una nota de crédito para la factura N° ${String((e=a.factura)==null?void 0:e.numero_factura).padStart(8,"0")}. Esta acción no se puede deshacer.`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#f57c00",cancelButtonColor:"#d33",confirmButtonText:"Sí, generar!",cancelButtonText:"Cancelar"}).then(h=>{h.isConfirmed&&(this.loading=!0,v.post(this.url+"/"+this.usuario.tpv+"/notasCredito/generar",{venta_id:a.id},{headers:{Authorization:this.usuario.token}}).then(l=>{var r;this.$swal("Nota de crédito generada",`Se ha generado exitosamente la nota de crédito para la factura N° ${String((r=a.factura)==null?void 0:r.numero_factura).padStart(8,"0")}`,"success"),this.consultarFacturas()}).catch(l=>{console.error("Error al generar nota de crédito:",l);let r="Error al generar la nota de crédito. Intente nuevamente.";l.response&&l.response.data&&l.response.data.message&&(r=l.response.data.message),this.$swal("Error",r,"error")}).finally(()=>{this.loading=!1}))})},establecerFechasDefault(){const a=new Date,e=new Date(a.getFullYear(),a.getMonth(),1);this.fechaDesde=e.toISOString().split("T")[0],this.fechaHasta=a.toISOString().split("T")[0]}},mounted(){this.establecerFechasDefault()}},H={key:0},z={key:1};function I(a,e,h,l,r,u){return f(),g(y,null,{default:t(()=>[o(b,null,{default:t(()=>[o(m,null,{default:t(()=>[o(x,null,{default:t(()=>[o(B,null,{default:t(()=>[...e[2]||(e[2]=[D("h2",null,"Facturas",-1)])]),_:1}),o(T,null,{default:t(()=>[o(b,{class:"mb-4"},{default:t(()=>[o(m,{md:"4",sm:"6",cols:"12"},{default:t(()=>[o(V,{modelValue:r.fechaDesde,"onUpdate:modelValue":e[0]||(e[0]=s=>r.fechaDesde=s),label:"Fecha Desde",type:"date",variant:"outlined",readonly:r.loading},null,8,["modelValue","readonly"])]),_:1}),o(m,{md:"4",sm:"6",cols:"12"},{default:t(()=>[o(V,{modelValue:r.fechaHasta,"onUpdate:modelValue":e[1]||(e[1]=s=>r.fechaHasta=s),label:"Fecha Hasta",type:"date",variant:"outlined",readonly:r.loading},null,8,["modelValue","readonly"])]),_:1}),o(m,{md:"4",sm:"12",cols:"12",class:"d-flex align-center"},{default:t(()=>[o(_,{color:"primary",onClick:u.consultarFacturas,loading:r.loading,disabled:!r.fechaDesde||!r.fechaHasta||r.loading},{default:t(()=>[o(p,{left:""},{default:t(()=>[...e[3]||(e[3]=[i("mdi-magnify",-1)])]),_:1}),e[4]||(e[4]=i(" Consultar ",-1))]),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1}),o(k,{headers:r.cabeceras,items:r.facturas,loading:r.loading,"loading-text":"Cargando facturas...","no-data-text":"No se encontraron facturas en el rango de fechas seleccionado","items-per-page":"10",class:"elevation-1"},{"item.factura.numero_factura":t(({item:s})=>{var n;return[i(c(String((n=s.factura)==null?void 0:n.numero_factura).padStart(8,"0")),1)]}),"item.factura.fecha":t(({item:s})=>{var n;return[i(c(u.formatearFecha((n=s.factura)==null?void 0:n.fecha)),1)]}),"item.factura.vto_cae":t(({item:s})=>{var n;return[i(c(u.formatearFecha((n=s.factura)==null?void 0:n.vto_cae)),1)]}),"item.monto":t(({item:s})=>[i(" $"+c(u.formatearMonto(s.monto)),1)]),"item.factura.tipo_factura":t(({item:s})=>{var n;return[o(M,{color:u.getTipoFacturaColor((n=s.factura)==null?void 0:n.tipo_factura),size:"small"},{default:t(()=>{var d;return[i(c(u.getTipoFacturaTexto((d=s.factura)==null?void 0:d.tipo_factura)),1)]}),_:2},1032,["color"])]}),"item.factura.nota_de_credito":t(({item:s})=>{var n;return[(n=s.factura)!=null&&n.nota_de_credito?(f(),N("div",H,[o(p,{color:"warning"},{default:t(()=>[...e[5]||(e[5]=[i(" mdi-file-document-minus ",-1)])]),_:1}),D("span",null," N°"+c(s.factura.nota_de_credito.numero_nota),1)])):(f(),N("span",z,"-"))]}),"item.acciones":t(({item:s})=>{var n,d,C;return[o(_,{icon:"",size:"small",color:"primary",onClick:S=>u.verFactura(s),title:`Ver factura N° ${String((n=s.factura)==null?void 0:n.numero_factura).padStart(8,"0")}`,class:"mr-1"},{default:t(()=>[o(p,null,{default:t(()=>[...e[6]||(e[6]=[i("mdi-eye",-1)])]),_:1})]),_:1},8,["onClick","title"]),(d=s.factura)!=null&&d.nota_de_credito?F("",!0):(f(),g(_,{key:0,icon:"",size:"small",color:"warning",onClick:S=>u.generarNotaCredito(s),title:`Generar nota de crédito para factura N° ${String((C=s.factura)==null?void 0:C.numero_factura).padStart(8,"0")}`},{default:t(()=>[o(p,null,{default:t(()=>[...e[7]||(e[7]=[i("mdi-file-document-minus",-1)])]),_:1})]),_:1},8,["onClick","title"]))]}),_:1},8,["headers","items","loading"]),r.mensaje?(f(),g(A,{key:0,type:r.tipoMensaje,class:"mt-4"},{default:t(()=>[i(c(r.mensaje),1)]),_:1},8,["type"])):F("",!0)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}const L=w(E,[["render",I]]);export{L as default};
